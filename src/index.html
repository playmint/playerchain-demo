<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
        />
        <meta
            http-equiv="Content-Security-Policy"
            content="
        connect-src socket: https: http: blob: ipc: npm: node: wss: ws: ws://localhost:*;
         script-src socket: https: http: blob: npm: node: http://localhost:* 'unsafe-eval' 'unsafe-inline';
         worker-src socket: https: http: blob: 'unsafe-eval' 'unsafe-inline';
          frame-src socket: https: http: blob: http://localhost:*;
            img-src socket: https: http: blob: http://localhost:*;
          child-src socket: https: http: blob:;
         object-src 'none';
      "
        />
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                background-color: transparent;
                font-size: 16px;
            }
            form,
            select,
            input,
            button {
                display: block;
                margin: 1rem;
                padding: 1rem;
                font-size: 1rem;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <form id="launcher">
            <fieldset>
                <legend>Network</legend>
                <label for="transport">Transport</label>
                <select id="transport" name="transport">
                    <option value="broadcast">broadcast</option>
                    <option value="socket">socket</option>
                </select>
                <label for="consensus">Consensus</label>
                <select id="consensus" name="consensus">
                    <option value="lockstep">lockstep</option>
                    <option value="none">none</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Channel</legend>
                <label for="numPlayers">Number of players</label>
                <select id="numPlayers" name="numPlayers">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <label for="channelName">Secret</label>
                <input id="channelName" name="channelName" type="text" />
            </fieldset>
            <fieldset>
                <legend>Launch</legend>
                <button type="submit" name="launch" value="1">Join</button>
            </fieldset>
        </form>
        <script type="module">
            import application from 'socket:application';

            let playerIndex = 0;

            async function launch(params) {
                playerIndex += 1;
                return application.createWindow({
                    index: playerIndex,
                    path: `player.html?${new URLSearchParams(params).toString()}`,
                });
            }

            document
                .getElementById('launcher')
                .addEventListener('submit', (event) => {
                    event.preventDefault();
                    const launchConfig = {
                        transport: document.getElementById('transport').value,
                        consensus: document.getElementById('consensus').value,
                        channelName:
                            document.getElementById('channelName').value,
                        numPlayers: document.getElementById('numPlayers').value,
                    };

                    const instances = Number(event.submitter.value);
                    const launching = [];
                    for (let i = 0; i < instances; i += 1) {
                        const win = launch(launchConfig);
                        launching.push(win);
                    }

                    launching
                        .then((frames) => {
                            console.log('launched', frames);
                        })
                        .catch((error) => {
                            console.error('launch error', error);
                        });
                });
        </script>
    </body>
</html>
